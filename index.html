<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>日程調整アプリ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Flatpickr (カレンダー) のCSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        body { font-family: 'Inter', 'Noto Sans JP', sans-serif; }
        .table-cell {
            min-width: 120px;
            text-align: center;
        }
        .name-cell {
            min-width: 120px;
            max-width: 200px;
            word-break: break-all;
        }
        .summary-row td {
            font-weight: bold;
        }
        .hidden { display: none; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #candidate-dates-input {
            cursor: pointer;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' class='feather feather-calendar'%3E%3Crect x='3' y='4' width='18' height='18' rx='2' ry='2'%3E%3C/rect%3E%3Cline x1='16' y1='2' x2='16' y2='6'%3E%3C/line%3E%3Cline x1='8' y1='2' x2='8' y2='6'%3E%3C/line%3E%3Cline x1='3' y1='10' x2='21' y2='10'%3E%3C/line%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.25em;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="app-container" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">

        <header class="mb-8 text-center">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">日程調整アプリ</h1>
            <p class="mt-2 text-lg text-gray-600">「調整さん」風のシンプルなスケジュール調整ツール</p>
        </header>

        <div id="loader" class="flex justify-center items-center py-20">
            <div class="loader"></div>
            <p class="ml-4 text-lg text-gray-600">読み込み中...</p>
        </div>

        <div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-6" role="alert">
            <strong class="font-bold">エラー:</strong>
            <span class="block sm:inline" id="error-text"></span>
        </div>

        <div id="create-event-page" class="hidden">
            <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg">
                <h2 class="text-2xl font-bold mb-6 text-gray-800">新しいイベントを作成</h2>
                <div class="space-y-6">
                    <div>
                        <label for="event-name" class="block text-sm font-medium text-gray-700 mb-1">イベント名</label>
                        <input type="text" id="event-name" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 transition" placeholder="例：忘年会">
                    </div>
                    <div>
                        <label for="event-description" class="block text-sm font-medium text-gray-700 mb-1">メモ</label>
                        <textarea id="event-description" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 transition" placeholder="例：お店の候補など"></textarea>
                    </div>
                    <div>
                        <label for="candidate-dates-input" class="block text-sm font-medium text-gray-700 mb-1">候補日程</label>
                        <input type="text" id="candidate-dates-input" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white" placeholder="クリックしてカレンダーから日付を選択">
                        <div id="selected-dates-container" class="mt-4 space-y-2"></div>
                    </div>
                    <div>
                        <label for="event-password" class="block text-sm font-medium text-gray-700 mb-1">パスワード (任意)</label>
                        <input type="password" id="event-password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 transition" placeholder="閲覧用パスワード">
                    </div>
                    <div>
                        <button id="create-event-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-transform transform hover:scale-105">
                            イベントを作成
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="password-prompt" class="hidden">
             <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg">
                <h2 class="text-2xl font-bold mb-6 text-gray-800">パスワード認証</h2>
                <p class="text-gray-600 mb-4">このイベントを閲覧するにはパスワードが必要です。</p>
                <div class="space-y-4">
                    <div>
                        <label for="password-input" class="block text-sm font-medium text-gray-700 mb-1">パスワード</label>
                        <input type="password" id="password-input" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                     <p id="password-error" class="text-red-500 text-sm hidden">パスワードが違います。</p>
                    <div>
                        <button id="submit-password-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300">
                            認証
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="event-page" class="hidden">
            <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg mb-8">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h2 id="event-name-display" class="text-2xl sm:text-3xl font-bold text-gray-900"></h2>
                        <p id="event-description-display" class="mt-2 text-gray-600 whitespace-pre-wrap"></p>
                    </div>
                    <button id="back-to-create-btn" class="text-blue-600 hover:underline flex-shrink-0 ml-4">← 新規作成</button>
                </div>
                <div class="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <p class="text-sm text-blue-800"><strong>共有URL:</strong> このページのURLをコピーして参加者に共有してください。</p>
                    <div class="mt-2 flex items-center">
                        <input type="text" id="share-url" readonly class="w-full bg-white px-3 py-2 border border-gray-300 rounded-l-lg focus:outline-none">
                        <button id="copy-url-btn" class="bg-blue-600 text-white px-4 py-2 rounded-r-lg hover:bg-blue-700">コピー</button>
                    </div>
                    <span id="copy-feedback" class="text-sm text-green-600 mt-1 hidden">コピーしました！</span>
                </div>
            </div>

            <div class="overflow-x-auto bg-white p-6 sm:p-8 rounded-2xl shadow-lg mb-8">
                <h3 class="text-xl font-bold mb-4">出欠表</h3>
                <div id="availability-table-container"></div>
            </div>

            <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg">
                <h3 class="text-xl font-bold mb-4">出欠を登録・更新</h3>
                <div class="space-y-4">
                    <div>
                        <label for="participant-name" class="block text-sm font-medium text-gray-700 mb-1">名前</label>
                        <input type="text" id="participant-name" class="w-full sm:w-1/2 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="あなたの名前">
                    </div>
                    <div id="availability-options-container"></div>
                    <div>
                        <label for="participant-comment" class="block text-sm font-medium text-gray-700 mb-1">コメント (任意)</label>
                        <input type="text" id="participant-comment" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="例：少し遅れます">
                    </div>
                    <div>
                        <button id="submit-response-btn" class="w-full sm:w-auto bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-4 focus:ring-green-300 transition-transform transform hover:scale-105">
                            登録・更新
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/ja.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const appId = 'chouseisan-on-github-pages';
        let db, auth;
        let currentEventId = null;
        let currentEventUnsubscribe = null;
        let selectedDates = [];
        let flatpickrInstance = null;
        let tempEventData = null; // パスワード認証前の一時的なデータ保持用

        const loader = document.getElementById('loader');
        const createEventPage = document.getElementById('create-event-page');
        const eventPage = document.getElementById('event-page');
        const passwordPrompt = document.getElementById('password-prompt');
        const errorContainer = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        
        async function initialize() {
            try {
                const firebaseConfig = {
                  apiKey: "AIzaSyA2ZIXFrJC3nGFTso1EsNnTCjWCkDyWX8Q",
                  authDomain: "schedule-app-51ab6.firebaseapp.com",
                  projectId: "schedule-app-51ab6",
                  storageBucket: "schedule-app-51ab6.appspot.com",
                  messagingSenderId: "1047698114975",
                  appId: "1:1047698114975:web:a8e7b4a4bf30f74e4095aa"
                };

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        startApp();
                    } else {
                         try {
                            await signInAnonymously(auth);
                        } catch (authError) {
                            console.error("Authentication error:", authError);
                            showError("認証に失敗しました。");
                        }
                    }
                });
                
            } catch (error) {
                console.error("初期化エラー:", error);
                showError("アプリケーションの初期化に失敗しました。ページを再読み込みしてください。");
            }
        }

        function startApp() {
            handleRouting();
            setupEventListeners();
        }

        function showPage(page) {
            createEventPage.classList.add('hidden');
            eventPage.classList.add('hidden');
            passwordPrompt.classList.add('hidden');
            loader.classList.add('hidden');
            errorContainer.classList.add('hidden');

            if (page === 'create') {
                createEventPage.classList.remove('hidden');
                initializeCalendar();
            } else if (page === 'event') {
                eventPage.classList.remove('hidden');
            } else if (page === 'password') {
                passwordPrompt.classList.remove('hidden');
            } else if (page === 'loader') {
                loader.classList.remove('hidden');
            }
        }

        function showError(message) {
            errorText.textContent = message;
            errorContainer.classList.remove('hidden');
            loader.classList.add('hidden');
            eventPage.classList.add('hidden');
            createEventPage.classList.add('hidden');
        }

        function handleRouting() {
            const params = new URLSearchParams(window.location.search);
            const eventId = params.get('id');

            if (eventId) {
                loadEvent(eventId);
            } else {
                showPage('create');
            }
        }

        function setupEventListeners() {
            document.getElementById('create-event-btn').addEventListener('click', createEvent);
            document.getElementById('submit-response-btn').addEventListener('click', submitResponse);
            document.getElementById('copy-url-btn').addEventListener('click', copyUrlToClipboard);
            document.getElementById('back-to-create-btn').addEventListener('click', () => {
                window.location.href = window.location.href.split('?')[0];
            });
            document.getElementById('submit-password-btn').addEventListener('click', verifyPassword);
            document.getElementById('selected-dates-container').addEventListener('click', (e) => {
                if (e.target && e.target.closest('.remove-date-btn')) {
                    const dateToRemove = e.target.closest('.remove-date-btn').dataset.date;
                    selectedDates = selectedDates.filter(d => d !== dateToRemove);
                    if (flatpickrInstance) {
                        flatpickrInstance.setDate(selectedDates);
                    }
                    renderSelectedDates();
                }
            });
        }

        function initializeCalendar() {
            if (flatpickrInstance) return;
            flatpickr.localize(flatpickr.l10ns.ja);
            flatpickrInstance = flatpickr("#candidate-dates-input", {
                mode: "multiple",
                dateFormat: "Y-m-d",
                minDate: "today",
                onChange: function(dates) {
                    selectedDates = dates.map(d => flatpickr.formatDate(d, "Y-m-d")).sort();
                    renderSelectedDates();
                }
            });
        }

        function renderSelectedDates() {
            const container = document.getElementById('selected-dates-container');
            container.innerHTML = '';
            selectedDates.forEach(dateStr => {
                const dateEl = document.createElement('div');
                dateEl.className = 'flex items-center justify-between bg-gray-100 p-2 rounded-lg text-sm';
                dateEl.innerHTML = `
                    <span>${formatDateForDisplay(dateStr)}</span>
                    <button data-date="${dateStr}" class="remove-date-btn text-red-500 hover:text-red-700 font-bold text-lg px-2">&times;</button>
                `;
                container.appendChild(dateEl);
            });
        }

        function formatDateForDisplay(dateStr) {
            try {
                const date = new Date(dateStr + 'T00:00:00');
                const year = date.getFullYear();
                const month = date.getMonth() + 1;
                const day = date.getDate();
                const dayOfWeek = ['日', '月', '火', '水', '木', '金', '土'][date.getDay()];
                return `${year}年${month}月${day}日 (${dayOfWeek})`;
            } catch (e) {
                return dateStr;
            }
        }

        async function createEvent() {
            const createBtn = document.getElementById('create-event-btn');
            const eventName = document.getElementById('event-name').value.trim();
            const description = document.getElementById('event-description').value.trim();
            const password = document.getElementById('event-password').value.trim();

            if (!eventName || selectedDates.length === 0) {
                alert('イベント名と候補日程は必須です。');
                return;
            }

            createBtn.disabled = true;
            createBtn.textContent = '作成中...';
            createBtn.classList.add('opacity-50', 'cursor-not-allowed');

            try {
                const eventData = {
                    name: eventName,
                    description: description,
                    candidateDates: selectedDates,
                    participants: [],
                    createdAt: serverTimestamp(),
                };

                if (password) {
                    eventData.password = password;
                }
                
                const collectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'chouseisan-events');
                const docRef = await addDoc(collectionRef, eventData);
                
                loadEvent(docRef.id);

            } catch (error) {
                console.error("イベント作成エラー:", error);
                showError("イベントの作成に失敗しました。");
                createBtn.disabled = false;
                createBtn.textContent = 'イベントを作成';
                createBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        async function loadEvent(eventId) {
            showPage('loader');
            currentEventId = eventId;

            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'chouseisan-events', eventId);
            
            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const eventData = docSnap.data();
                    tempEventData = eventData; // データを一時保存
                    
                    // セッションストレージで認証済みか確認
                    const isAuthenticated = sessionStorage.getItem(`event_auth_${eventId}`) === 'true';

                    if (eventData.password && !isAuthenticated) {
                        showPage('password');
                    } else {
                        displayEvent(eventId, eventData);
                        listenForEventUpdates(eventId);
                        showPage('event');
                    }
                } else {
                    showError("指定されたイベントが見つかりません。URLが正しいか確認してください。");
                }
            } catch (error) {
                console.error("イベント読み込みエラー:", error);
                showError("イベントの読み込み中にエラーが発生しました。");
            }
        }

        function verifyPassword() {
            const enteredPassword = document.getElementById('password-input').value;
            if (enteredPassword === tempEventData.password) {
                sessionStorage.setItem(`event_auth_${currentEventId}`, 'true');
                displayEvent(currentEventId, tempEventData);
                listenForEventUpdates(currentEventId);
                showPage('event');
            } else {
                const passwordError = document.getElementById('password-error');
                passwordError.classList.remove('hidden');
            }
        }

        function listenForEventUpdates(eventId) {
            if (currentEventUnsubscribe) {
                currentEventUnsubscribe();
            }
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'chouseisan-events', eventId);
            currentEventUnsubscribe = onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    displayEvent(eventId, docSnap.data());
                }
            }, (error) => {
                 console.error("リアルタイム更新エラー:", error);
                 showError("イベントの更新情報の取得に失敗しました。");
            });
        }

        function displayEvent(eventId, eventData) {
            document.getElementById('event-name-display').textContent = eventData.name;
            document.getElementById('event-description-display').textContent = eventData.description;
            
            const baseUrl = window.location.href.split('?')[0];
            const newUrl  = `${baseUrl}?id=${eventId}`;
            document.getElementById('share-url').value = newUrl;

            renderAvailabilityTable(eventData.candidateDates, eventData.participants);
            renderAvailabilityOptions(eventData.candidateDates);
        }
        
        function renderAvailabilityTable(dates, participants) {
            const container = document.getElementById('availability-table-container');
            const statusMap = { '○': 'bg-green-100 text-green-800', '△': 'bg-yellow-100 text-yellow-800', '×': 'bg-red-100 text-red-800' };
            const statusIcons = { '○': '○', '△': '△', '×': '×' };

            let tableHTML = `<table class="min-w-full divide-y divide-gray-200">`;
            
            tableHTML += `<thead class="bg-gray-50"><tr>`;
            tableHTML += `<th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider name-cell">名前</th>`;
            (dates || []).forEach(date => {
                tableHTML += `<th class="px-3 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider table-cell">${formatDateForDisplay(date).replace(' ', '<br>')}</th>`;
            });
            tableHTML += `<th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider name-cell">コメント</th>`;
            tableHTML += `</tr></thead>`;

            tableHTML += `<tbody class="bg-white divide-y divide-gray-200">`;
            (participants || []).forEach(p => {
                tableHTML += `<tr>`;
                tableHTML += `<td class="px-3 py-4 whitespace-nowrap text-sm font-medium text-gray-900 name-cell">${p.name}</td>`;
                (p.availability || []).forEach(status => {
                    tableHTML += `<td class="px-3 py-4 whitespace-nowrap text-2xl font-bold table-cell ${statusMap[status] || ''}">${statusIcons[status] || ''}</td>`;
                });
                tableHTML += `<td class="px-3 py-4 text-sm text-gray-500 name-cell">${p.comment || ''}</td>`;
                tableHTML += `</tr>`;
            });
            tableHTML += `</tbody>`;

            const summary = { '○': Array((dates || []).length).fill(0), '△': Array((dates || []).length).fill(0), '×': Array((dates || []).length).fill(0) };
            (participants || []).forEach(p => {
                (p.availability || []).forEach((status, i) => {
                    if (summary[status] && i < (dates || []).length) {
                        summary[status][i]++;
                    }
                });
            });

            tableHTML += `<tfoot class="bg-gray-100">`;
            ['○', '△', '×'].forEach(status => {
                tableHTML += `<tr class="summary-row">`;
                tableHTML += `<td class="px-3 py-3 text-lg font-bold text-center ${statusMap[status]}">${status}</td>`;
                summary[status].forEach(count => {
                    tableHTML += `<td class="px-3 py-3 text-center text-lg font-bold ${statusMap[status]}">${count}</td>`;
                });
                tableHTML += `<td></td>`;
                tableHTML += `</tr>`;
            });
            tableHTML += `</tfoot></table>`;
            container.innerHTML = tableHTML;
        }

        function renderAvailabilityOptions(dates) {
            const container = document.getElementById('availability-options-container');
            let optionsHTML = '<p class="block text-sm font-medium text-gray-700 mb-2">各日程の出欠</p><div class="space-y-3">';
            (dates || []).forEach((date, index) => {
                optionsHTML += `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <span class="font-medium text-gray-800">${formatDateForDisplay(date)}</span>
                        <fieldset class="flex space-x-2 sm:space-x-4">
                            <label class="flex items-center space-x-1 cursor-pointer">
                                <input type="radio" name="availability-${index}" value="○" class="form-radio h-5 w-5 text-green-600">
                                <span class="text-xl font-bold text-green-600">○</span>
                            </label>
                            <label class="flex items-center space-x-1 cursor-pointer">
                                <input type="radio" name="availability-${index}" value="△" class="form-radio h-5 w-5 text-yellow-600">
                                <span class="text-xl font-bold text-yellow-600">△</span>
                            </label>
                            <label class="flex items-center space-x-1 cursor-pointer">
                                <input type="radio" name="availability-${index}" value="×" class="form-radio h-5 w-5 text-red-600">
                                <span class="text-xl font-bold text-red-600">×</span>
                            </label>
                        </fieldset>
                    </div>
                `;
            });
            optionsHTML += '</div>';
            container.innerHTML = optionsHTML;
        }

        async function submitResponse() {
            const name = document.getElementById('participant-name').value.trim();
            if (!name) {
                alert('名前を入力してください。');
                return;
            }

            const eventId = currentEventId;
            if (!eventId) {
                showError("イベントIDが見つかりません。ページを更新してください。");
                return;
            }

            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'chouseisan-events', eventId);

            try {
                const docSnap = await getDoc(docRef);
                if (!docSnap.exists()) {
                    showError("イベントが見つかりません。");
                    return;
                }

                const eventData = docSnap.data();
                const availability = [];
                let allAnswered = true;
                eventData.candidateDates.forEach((_, index) => {
                    const selected = document.querySelector(`input[name="availability-${index}"]:checked`);
                    if (selected) {
                        availability.push(selected.value);
                    } else {
                        allAnswered = false;
                    }
                });

                if (!allAnswered) {
                    alert('すべての日程について出欠を選択してください。');
                    return;
                }
                
                const comment = document.getElementById('participant-comment').value.trim();
                const newParticipant = { name, availability, comment };

                const participants = eventData.participants || [];
                const existingParticipantIndex = participants.findIndex(p => p.name === name);

                if (existingParticipantIndex > -1) {
                    participants[existingParticipantIndex] = newParticipant;
                } else {
                    participants.push(newParticipant);
                }

                await setDoc(docRef, { participants: participants }, { merge: true });
                alert('出欠を登録・更新しました。');
                
                document.getElementById('participant-name').value = '';
                document.getElementById('participant-comment').value = '';
                document.querySelectorAll('input[type="radio"]').forEach(radio => radio.checked = false);


            } catch (error) {
                console.error("出欠登録エラー:", error);
                showError("出欠の登録に失敗しました。");
            }
        }
        
        function copyUrlToClipboard() {
            const urlInput = document.getElementById('share-url');
            urlInput.select();
            try {
                const successful = document.execCommand('copy');
                const feedback = document.getElementById('copy-feedback');
                if(successful) {
                    feedback.classList.remove('hidden');
                    setTimeout(() => {
                        feedback.classList.add('hidden');
                    }, 2000);
                }
            } catch (err) {
                alert('URLのコピーに失敗しました。手動でコピーしてください。');
            }
        }

        initialize();

    </script>

</body>
</html>
