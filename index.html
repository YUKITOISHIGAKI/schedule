<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>æ—¥ç¨‹èª¿æ•´å¤ªéƒ</title>

  <!-- UI -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;500;700&display=swap" rel="stylesheet"/>

  <!-- Flatpickr -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"/>

  <style>
    body { font-family: 'M PLUS Rounded 1c','Inter','Noto Sans JP',sans-serif; }
    .table-cell { min-width: 120px; text-align: center; }
    .name-cell { min-width: 120px; max-width: 200px; word-break: break-all; }
    .summary-row td { font-weight: bold; }
    .hidden { display: none; }
    .loader {
      border: 4px solid #fce7f3; border-top: 4px solid #ec4899;
      border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;
    }
    @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
    #candidate-dates-input {
      cursor: pointer;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23ec4899' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' class='feather feather-calendar'%3E%3Crect x='3' y='4' width='18' height='18' rx='2' ry='2'%3E%3C/rect%3E%3Cline x1='16' y1='2' x2='16' y2='6'%3E%3C/line%3E%3Cline x1='8' y1='2' x2='8' y2='6'%3E%3C/line%3E%3Cline x1='3' y1='10' x2='21' y2='10'%3E%3C/line%3E%3C/svg%3E");
      background-repeat:no-repeat; background-position:right .75rem center; background-size:1.25em;
    }
    /* ğŸ‘‘ãƒ›ãƒãƒ¼ */
    #best-day-badge { cursor: pointer; transition: transform .05s ease; }
    #best-day-badge:active { transform: scale(.98); }
  </style>
</head>
<body class="bg-pink-50 text-gray-800">
  <div id="app-container" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
    <header class="mb-8 text-center">
      <h1 class="text-3xl sm:text-4xl font-bold text-pink-600">æ—¥ç¨‹èª¿æ•´å¤ªéƒ</h1>
      <p class="mt-2 text-lg text-pink-500">ãƒ¡ãƒ¼ãƒ«ã§äºˆå®šèª¿æ•´ã£ã¦é¢å€’ã ã‚ˆã­</p>
    </header>

    <div id="loader" class="flex justify-center items-center py-20">
      <div class="loader"></div>
      <p class="ml-4 text-lg text-gray-600">èª­ã¿è¾¼ã¿ä¸­...</p>
    </div>

    <div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-6" role="alert">
      <strong class="font-bold">ã‚¨ãƒ©ãƒ¼:</strong>
      <span class="block sm:inline" id="error-text"></span>
    </div>

    <!-- ä½œæˆãƒšãƒ¼ã‚¸ -->
    <div id="create-event-page" class="hidden">
      <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg">
        <h2 class="text-2xl font-bold mb-6 text-gray-800">æ–°ã—ã„ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä½œæˆ</h2>
        <div class="space-y-6">
          <div>
            <label for="event-name" class="block text-sm font-medium text-gray-700 mb-1">ã‚¤ãƒ™ãƒ³ãƒˆå</label>
            <input id="event-name" type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 transition" placeholder="ä¾‹ï¼šå¥³å­ä¼šãƒ©ãƒ³ãƒ"/>
          </div>
          <div>
            <label for="event-description" class="block text-sm font-medium text-gray-700 mb-1">ãƒ¡ãƒ¢</label>
            <textarea id="event-description" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 transition" placeholder="ä¾‹ï¼šãŠåº—ã®å€™è£œã¨ã‹æ›¸ã„ã¨ã“ï¼"></textarea>
          </div>
          <div>
            <label for="candidate-dates-input" class="block text-sm font-medium text-gray-700 mb-1">å€™è£œæ—¥æ™‚</label>
            <input id="candidate-dates-input" type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white" placeholder="ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰æ—¥æ™‚ã‚’é¸æŠ"/>
            <div id="selected-dates-container" class="mt-4 space-y-2"></div>
          </div>
          <div>
            <label for="event-password" class="block text-sm font-medium text-gray-700 mb-1">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ (ä»»æ„)</label>
            <input id="event-password" type="password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 transition" placeholder="ãªã„ã—ã‚‡ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰"/>
          </div>
          <div>
            <button id="create-event-btn" class="w-full bg-pink-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-pink-600 focus:outline-none focus:ring-4 focus:ring-pink-300 transition-transform transform hover:scale-105">ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä½œæˆ</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ -->
    <div id="password-prompt" class="hidden">
      <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg">
        <h2 class="text-2xl font-bold mb-6 text-gray-800">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼</h2>
        <p class="text-gray-600 mb-4">ã“ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’é–²è¦§ã™ã‚‹ã«ã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå¿…è¦ã§ã™ã€‚</p>
        <div class="space-y-4">
          <div>
            <label for="password-input" class="block text-sm font-medium text-gray-700 mb-1">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
            <input id="password-input" type="password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500"/>
          </div>
          <p id="password-error" class="text-red-500 text-sm hidden">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™ã€‚</p>
          <div>
            <button id="submit-password-btn" class="w-full bg-pink-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-pink-600 focus:outline-none focus:ring-4 focus:ring-pink-300">èªè¨¼</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ã‚¤ãƒ™ãƒ³ãƒˆãƒšãƒ¼ã‚¸ -->
    <div id="event-page" class="hidden">
      <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg mb-8">
        <div class="flex justify-between items-start mb-4">
          <div>
            <h2 id="event-name-display" class="text-2xl sm:text-3xl font-bold text-gray-900"></h2>
            <p id="event-description-display" class="mt-2 text-gray-600 whitespace-pre-wrap"></p>
          </div>
          <button id="back-to-create-btn" class="text-pink-600 hover:underline flex-shrink-0 ml-4">â† æ–°è¦ä½œæˆ</button>
        </div>
        <div class="mt-4 p-4 bg-pink-50 border border-pink-200 rounded-lg">
          <p class="text-sm text-pink-800"><strong>å…±æœ‰URL:</strong> ã“ã®ãƒšãƒ¼ã‚¸ã®URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¦å‚åŠ è€…ã«å…±æœ‰ã—ã¦ãã ã•ã„ã€‚</p>
          <div class="mt-2 flex items-center">
            <input id="share-url" type="text" readonly class="w-full bg-white px-3 py-2 border border-gray-300 rounded-l-lg focus:outline-none"/>
            <button id="copy-url-btn" class="bg-pink-500 text-white px-4 py-2 rounded-r-lg hover:bg-pink-600">ã‚³ãƒ”ãƒ¼</button>
          </div>
          <span id="copy-feedback" class="text-sm text-green-600 mt-1 hidden">ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼</span>
        </div>
      </div>

      <!-- å‡ºæ¬ è¡¨ -->
      <div class="overflow-x-auto bg-white p-6 sm:p-8 rounded-2xl shadow-lg mb-8">
        <h3 class="text-xl font-bold mb-4">å‡ºæ¬ è¡¨</h3>
        <div id="availability-table-container"></div>
      </div>

      <!-- é›†è¨ˆã®å¯è¦–åŒ–ï¼ˆâ­•ï¸æ£’ã‚°ãƒ©ãƒ•ã®ã¿ï¼‹æœ¬å‘½ãƒãƒƒã‚¸ï¼‹ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼‰ -->
      <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg mb-8">
        <h3 class="text-xl font-bold mb-4">é›†è¨ˆã®å¯è¦–åŒ–</h3>

        <!-- ğŸ‘‘ æœ¬å‘½ãƒãƒƒã‚¸ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§ç´™å¹é›ªï¼‰ -->
        <div id="best-day-badge" class="mb-4 hidden" title="ã‚¯ãƒªãƒƒã‚¯ã§ãŠç¥ã„ï¼ğŸ‰">
          <span class="inline-flex items-center px-3 py-1 rounded-full bg-yellow-100 text-yellow-800 text-sm font-semibold">
            ğŸ‘‘ æœ¬å‘½ï¼š<span id="best-day-text" class="ml-1"></span>
          </span>
        </div>

        <!-- æ£’ã‚°ãƒ©ãƒ•ï¼ˆâ­•ï¸ã®ã¿ï¼‰ -->
        <div class="w-full max-w-4xl">
          <canvas id="summary-chart" height="160"></canvas>
        </div>

        <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚° -->
        <div class="mt-6">
          <h4 class="font-semibold mb-2">â—‹ã®å¤šã„é †ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h4>
          <ol id="ranking-list" class="list-decimal list-inside text-sm text-gray-800 space-y-1"></ol>
        </div>
      </div>

      <!-- å‚åŠ å…¥åŠ› -->
      <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg">
        <h3 class="text-xl font-bold mb-4">å‡ºæ¬ ã‚’ç™»éŒ²ãƒ»æ›´æ–°</h3>
        <div class="space-y-4">
          <div>
            <label for="participant-name" class="block text-sm font-medium text-gray-700 mb-1">åå‰</label>
            <input id="participant-name" type="text" class="w-full sm:w-1/2 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500" placeholder="ã‚ãªãŸã®åå‰"/>
          </div>
          <div id="availability-options-container"></div>
          <div>
            <label for="participant-comment" class="block text-sm font-medium text-gray-700 mb-1">ã‚³ãƒ¡ãƒ³ãƒˆ (ä»»æ„)</label>
            <input id="participant-comment" type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500" placeholder="ä¾‹ï¼šã¡ã‚‡ã£ã¨é…ã‚Œã‚‹ã‹ã‚‚ï¼"/>
          </div>
          <div>
            <button id="submit-response-btn" class="w-full sm:w-auto bg-rose-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-rose-600 focus:outline-none focus:ring-4 focus:ring-rose-300 transition-transform transform hover:scale-105">ç™»éŒ²ãƒ»æ›´æ–°</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://npmcdn.com/flatpickr/dist/l10n/ja.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const appId = 'chouseisan-on-github-pages';
    let db, auth;
    let currentEventId = null;
    let currentEventUnsubscribe = null;
    let selectedDates = [];
    let flatpickrInstance = null;
    let tempEventData = null;

    const loader = document.getElementById('loader');
    const createEventPage = document.getElementById('create-event-page');
    const eventPage = document.getElementById('event-page');
    const passwordPrompt = document.getElementById('password-prompt');
    const errorContainer = document.getElementById('error-message');
    const errorText = document.getElementById('error-text');

    async function initialize() {
      try {
        const firebaseConfig = {
          apiKey: "AIzaSyA2ZIXFrJC3nGFTso1EsNnTCjWCkDyWX8Q",
          authDomain: "schedule-app-51ab6.firebaseapp.com",
          projectId: "schedule-app-51ab6",
          storageBucket: "schedule-app-51ab6.appspot.com",
          messagingSenderId: "1047698114975",
          appId: "1:1047698114975:web:a8e7b4a4bf30f74e4095aa"
        };

        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        onAuthStateChanged(auth, async (user) => {
          if (user) startApp();
          else {
            try { await signInAnonymously(auth); }
            catch(e){ console.error(e); showError("èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"); }
          }
        });
      } catch (e) {
        console.error("åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:", e);
        showError("ã‚¢ãƒ—ãƒªåˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚");
      }
    }

    function startApp(){ handleRouting(); setupEventListeners(); }

    function showPage(page){
      createEventPage.classList.add('hidden');
      eventPage.classList.add('hidden');
      passwordPrompt.classList.add('hidden');
      loader.classList.add('hidden');
      errorContainer.classList.add('hidden');

      if(page==='create'){ createEventPage.classList.remove('hidden'); initializeCalendar(); }
      else if(page==='event'){ eventPage.classList.remove('hidden'); }
      else if(page==='password'){ passwordPrompt.classList.remove('hidden'); }
      else if(page==='loader'){ loader.classList.remove('hidden'); }
    }

    function showError(msg){
      errorText.textContent = msg;
      errorContainer.classList.remove('hidden');
      loader.classList.add('hidden');
      eventPage.classList.add('hidden');
      createEventPage.classList.add('hidden');
    }

    function handleRouting(){
      const params = new URLSearchParams(window.location.search);
      const eventId = params.get('id');
      if(eventId) loadEvent(eventId);
      else showPage('create');
    }

    function setupEventListeners(){
      document.getElementById('create-event-btn').addEventListener('click', createEvent);
      document.getElementById('submit-response-btn').addEventListener('click', submitResponse);
      document.getElementById('copy-url-btn').addEventListener('click', copyUrlToClipboard);
      document.getElementById('back-to-create-btn').addEventListener('click', () => {
        window.location.href = window.location.href.split('?')[0];
      });
      document.getElementById('submit-password-btn').addEventListener('click', verifyPassword);
      document.getElementById('selected-dates-container').addEventListener('click', (e)=>{
        if(e.target && e.target.closest('.remove-date-btn')){
          const dateToRemove = e.target.closest('.remove-date-btn').dataset.date;
          selectedDates = selectedDates.filter(d=> d!==dateToRemove);
          if(flatpickrInstance) flatpickrInstance.setDate(selectedDates.map(d=> new Date(d)));
          renderSelectedDates();
        }
      });

      // ğŸ‘‘ã‚¯ãƒªãƒƒã‚¯ã§ç´™å¹é›ª
      document.getElementById('best-day-badge').addEventListener('click', ()=> confettiBurst());
    }

    function initializeCalendar(){
      if(flatpickrInstance) return;
      flatpickr.localize(flatpickr.l10ns.ja);
      flatpickrInstance = flatpickr("#candidate-dates-input", {
        mode: "multiple",
        enableTime: true,
        dateFormat: "Y-m-d H:i",
        time_24hr: true,
        minDate: "today",
        onChange: function(dates){
          selectedDates = dates.map(d => flatpickr.formatDate(d, "Y-m-d H:i")).sort();
          renderSelectedDates();
        }
      });
    }

    function renderSelectedDates(){
      const container = document.getElementById('selected-dates-container');
      container.innerHTML = '';
      selectedDates.forEach(dateStr=>{
        const el = document.createElement('div');
        el.className = 'flex items-center justify-between bg-gray-100 p-2 rounded-lg text-sm';
        el.innerHTML = `
          <span>${formatDateForDisplay(dateStr)}</span>
          <button data-date="${dateStr}" class="remove-date-btn text-red-500 hover:text-red-700 font-bold text-lg px-2">&times;</button>
        `;
        container.appendChild(el);
      });
    }

    function formatDateForDisplay(dateStr){
      try{
        const date = new Date(dateStr.replace(' ','T'));
        const y = date.getFullYear();
        const m = date.getMonth()+1;
        const d = date.getDate();
        const w = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][date.getDay()];
        const hh = String(date.getHours()).padStart(2,'0');
        const mm = String(date.getMinutes()).padStart(2,'0');
        return `${y}å¹´${m}æœˆ${d}æ—¥(${w}) ${hh}:${mm}`;
      }catch{ return dateStr; }
    }

    async function createEvent(){
      const btn = document.getElementById('create-event-btn');
      const name = document.getElementById('event-name').value.trim();
      const description = document.getElementById('event-description').value.trim();
      const password = document.getElementById('event-password').value.trim();

      if(!name || selectedDates.length===0){ alert('ã‚¤ãƒ™ãƒ³ãƒˆåã¨å€™è£œæ—¥æ™‚ã¯å¿…é ˆã§ã™ã€‚'); return; }

      btn.disabled = true; btn.textContent = 'ä½œæˆä¸­...'; btn.classList.add('opacity-50','cursor-not-allowed');

      try{
        const eventData = { name, description, candidateDates: selectedDates, participants: [], createdAt: serverTimestamp() };
        if(password) eventData.password = password;

        const colRef = collection(db,'artifacts',appId,'public','data','chouseisan-events');
        const docRef = await addDoc(colRef, eventData);
        loadEvent(docRef.id);
      }catch(e){
        console.error("ã‚¤ãƒ™ãƒ³ãƒˆä½œæˆã‚¨ãƒ©ãƒ¼:", e);
        showError("ã‚¤ãƒ™ãƒ³ãƒˆã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
        btn.disabled = false; btn.textContent = 'ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä½œæˆ'; btn.classList.remove('opacity-50','cursor-not-allowed');
      }
    }

    async function loadEvent(eventId){
      showPage('loader');
      currentEventId = eventId;
      const ref = doc(db,'artifacts',appId,'public','data','chouseisan-events',eventId);
      try{
        const snap = await getDoc(ref);
        if(snap.exists()){
          const data = snap.data();
          tempEventData = data;
          const authed = sessionStorage.getItem(`event_auth_${eventId}`) === 'true';
          if(data.password && !authed){ showPage('password'); }
          else { displayEvent(eventId,data); listenForEventUpdates(eventId); showPage('event'); }
        }else{
          showError("æŒ‡å®šã•ã‚ŒãŸã‚¤ãƒ™ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚URLãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
        }
      }catch(e){
        console.error("ã‚¤ãƒ™ãƒ³ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", e);
        showError("ã‚¤ãƒ™ãƒ³ãƒˆã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
      }
    }

    function verifyPassword(){
      const entered = document.getElementById('password-input').value;
      if(entered === tempEventData.password){
        sessionStorage.setItem(`event_auth_${currentEventId}`,'true');
        displayEvent(currentEventId,tempEventData);
        listenForEventUpdates(currentEventId);
        showPage('event');
      }else{
        document.getElementById('password-error').classList.remove('hidden');
      }
    }

    function listenForEventUpdates(eventId){
      if(currentEventUnsubscribe) currentEventUnsubscribe();
      const ref = doc(db,'artifacts',appId,'public','data','chouseisan-events',eventId);
      currentEventUnsubscribe = onSnapshot(ref, (snap)=>{
        if(snap.exists()) displayEvent(eventId, snap.data());
      }, (err)=>{
        console.error("ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã‚¨ãƒ©ãƒ¼:", err);
        showError("ã‚¤ãƒ™ãƒ³ãƒˆã®æ›´æ–°æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
      });
    }

    function displayEvent(eventId, data){
      document.getElementById('event-name-display').textContent = data.name;
      document.getElementById('event-description-display').textContent = data.description;

      const base = window.location.href.split('?')[0];
      document.getElementById('share-url').value = `${base}?id=${eventId}`;

      renderAvailabilityTable(data.candidateDates, data.participants);
      renderAvailabilityOptions(data.candidateDates);

      // âœ… é›†è¨ˆã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆæ›´æ–°
      renderSummaryWidgets(data.candidateDates, data.participants);
    }

    function renderAvailabilityTable(dates, participants){
      const container = document.getElementById('availability-table-container');
      const statusMap = { 'â—‹':'bg-pink-100 text-pink-800','â–³':'bg-orange-100 text-orange-800','Ã—':'bg-red-100 text-red-800' };
      const statusIcons = { 'â—‹':'â—‹','â–³':'â–³','Ã—':'Ã—' };

      let html = `<table class="min-w-full divide-y divide-gray-200">`;
      html += `<thead class="bg-gray-50"><tr>`;
      html += `<th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider name-cell">åå‰</th>`;
      (dates||[]).forEach(date=>{
        html += `<th class="px-3 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider table-cell">${formatDateForDisplay(date).replace(' ','<br>')}</th>`;
      });
      html += `<th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider name-cell">ã‚³ãƒ¡ãƒ³ãƒˆ</th>`;
      html += `</tr></thead>`;

      html += `<tbody class="bg-white divide-y divide-gray-200">`;
      (participants||[]).forEach(p=>{
        html += `<tr>`;
        html += `<td class="px-3 py-4 whitespace-nowrap text-sm font-medium text-gray-900 name-cell">${p.name}</td>`;
        (p.availability||[]).forEach(st=>{
          html += `<td class="px-3 py-4 whitespace-nowrap text-2xl font-bold table-cell ${statusMap[st]||''}">${statusIcons[st]||''}</td>`;
        });
        html += `<td class="px-3 py-4 text-sm text-gray-500 name-cell">${p.comment||''}</td>`;
        html += `</tr>`;
      });
      html += `</tbody>`;

      // ãƒ•ãƒƒã‚¿ãƒ¼é›†è¨ˆ
      const summary = { 'â—‹':Array((dates||[]).length).fill(0), 'â–³':Array((dates||[]).length).fill(0), 'Ã—':Array((dates||[]).length).fill(0) };
      (participants||[]).forEach(p=>{
        (p.availability||[]).forEach((st,i)=>{
          if(summary[st] && i<(dates||[]).length) summary[st][i]++;
        });
      });

      html += `<tfoot class="bg-gray-100">`;
      ['â—‹','â–³','Ã—'].forEach(st=>{
        html += `<tr class="summary-row">`;
        html += `<td class="px-3 py-3 text-lg font-bold text-center ${statusMap[st]}">${st}</td>`;
        summary[st].forEach(cnt=>{
          html += `<td class="px-3 py-3 text-center text-lg font-bold ${statusMap[st]}">${cnt}</td>`;
        });
        html += `<td></td></tr>`;
      });
      html += `</tfoot></table>`;
      container.innerHTML = html;
    }

    function renderAvailabilityOptions(dates){
      const container = document.getElementById('availability-options-container');
      let html = '<p class="block text-sm font-medium text-gray-700 mb-2">å„æ—¥ç¨‹ã®å‡ºæ¬ </p><div class="space-y-3">';
      (dates||[]).forEach((date,idx)=>{
        html += `
          <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
            <span class="font-medium text-gray-800">${formatDateForDisplay(date)}</span>
            <fieldset class="flex space-x-2 sm:space-x-4">
              <label class="flex items-center space-x-1 cursor-pointer">
                <input type="radio" name="availability-${idx}" value="â—‹" class="form-radio h-5 w-5 text-pink-500">
                <span class="text-xl font-bold text-pink-500">â—‹</span>
              </label>
              <label class="flex items-center space-x-1 cursor-pointer">
                <input type="radio" name="availability-${idx}" value="â–³" class="form-radio h-5 w-5 text-orange-400">
                <span class="text-xl font-bold text-orange-400">â–³</span>
              </label>
              <label class="flex items-center space-x-1 cursor-pointer">
                <input type="radio" name="availability-${idx}" value="Ã—" class="form-radio h-5 w-5 text-red-600">
                <span class="text-xl font-bold text-red-600">Ã—</span>
              </label>
            </fieldset>
          </div>`;
      });
      html += '</div>';
      container.innerHTML = html;
    }

    async function submitResponse(){
      const name = document.getElementById('participant-name').value.trim();
      if(!name){ alert('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; }

      const eventId = currentEventId;
      if(!eventId){ showError("ã‚¤ãƒ™ãƒ³ãƒˆIDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°ã—ã¦ãã ã•ã„ã€‚"); return; }

      const ref = doc(db,'artifacts',appId,'public','data','chouseisan-events',eventId);
      try{
        const snap = await getDoc(ref);
        if(!snap.exists()){ showError("ã‚¤ãƒ™ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚"); return; }

        const data = snap.data();
        const availability = [];
        let allAnswered = true;
        data.candidateDates.forEach((_,i)=>{
          const sel = document.querySelector(`input[name="availability-${i}"]:checked`);
          if(sel) availability.push(sel.value); else allAnswered = false;
        });
        if(!allAnswered){ alert('ã™ã¹ã¦ã®æ—¥ç¨‹ã«ã¤ã„ã¦å‡ºæ¬ ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚'); return; }

        const comment = document.getElementById('participant-comment').value.trim();
        const newP = { name, availability, comment };

        const ps = data.participants || [];
        const idx = ps.findIndex(p=> p.name===name);
        if(idx>-1) ps[idx] = newP; else ps.push(newP);

        await setDoc(ref, { participants: ps }, { merge:true });
        alert('å‡ºæ¬ ã‚’ç™»éŒ²ãƒ»æ›´æ–°ã—ã¾ã—ãŸã€‚');

        document.getElementById('participant-name').value = '';
        document.getElementById('participant-comment').value = '';
        document.querySelectorAll('input[type="radio"]').forEach(r=> r.checked=false);

        // æ§ãˆã‚ç´™å¹é›ª
        confettiBurst({ mini:true });
      }catch(e){
        console.error("å‡ºæ¬ ç™»éŒ²ã‚¨ãƒ©ãƒ¼:", e);
        showError("å‡ºæ¬ ã®ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
      }
    }

    function copyUrlToClipboard(){
      const input = document.getElementById('share-url');
      input.select();
      try{
        const ok = document.execCommand('copy');
        const fb = document.getElementById('copy-feedback');
        if(ok){ fb.classList.remove('hidden'); setTimeout(()=>fb.classList.add('hidden'),2000); }
      }catch{ alert('URLã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚'); }
    }

    // ======== é›†è¨ˆ & å¯è¦–åŒ–ï¼ˆâ­•ï¸ã ã‘ã®æ£’ã‚°ãƒ©ãƒ•ï¼‰ ========
    let summaryChartInstance = null;

    function computeSummary(dates, participants){
      const n = (dates||[]).length;
      const summary = { 'â—‹':Array(n).fill(0), 'â–³':Array(n).fill(0), 'Ã—':Array(n).fill(0) };
      (participants||[]).forEach(p=>{
        (p.availability||[]).forEach((st,i)=>{
          if(summary[st] && i<n) summary[st][i]++;
        });
      });
      return summary;
    }

    function getBestIndex(okCounts){
      let best=-1, bestVal=-1;
      (okCounts||[]).forEach((v,i)=>{ if(v>bestVal){ bestVal=v; best=i; } });
      return best;
    }

    function humanDate(dateStr){ return formatDateForDisplay(dateStr); }

    // â­•ï¸ã®ã¿ã®æ£’ã‚°ãƒ©ãƒ•
    function renderSummaryChart(dates, summary){
      const labels = (dates||[]).map(d=> humanDate(d).replace(' ','\n'));
      const ok = summary['â—‹'];
      const ctx = document.getElementById('summary-chart').getContext('2d');

      if(summaryChartInstance) summaryChartInstance.destroy();

      summaryChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [
            { label: 'â—‹ï¼ˆå‚åŠ ã§ãã‚‹äººæ•°ï¼‰', data: ok, backgroundColor: 'rgba(236, 72, 153, 0.75)' } // pink
          ]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } },
          scales: { x: { ticks: { maxRotation: 0, minRotation: 0 } }, y: { beginAtZero: true, precision: 0 } }
        }
      });
    }

    function renderRanking(dates, okCounts, maybeCounts){
      const list = document.getElementById('ranking-list');
      const arr = (dates||[]).map((d,i)=>({ idx:i, label:humanDate(d), ok: okCounts?.[i]||0, maybe: maybeCounts?.[i]||0 }));
      arr.sort((a,b)=> (b.ok-a.ok) || (b.maybe-a.maybe));

      list.innerHTML = '';
      arr.forEach((item,rank)=>{
        const li = document.createElement('li');
        li.innerHTML = `<span class="font-medium">${item.label}</span> â€” â—‹ ${item.ok}äºº / â–³ ${item.maybe}äºº`;
        if(rank===0) li.innerHTML = `ğŸ‘‘ ${li.innerHTML}`;
        list.appendChild(li);
      });
    }

    function renderBestBadge(dates, okCounts){
      const badge = document.getElementById('best-day-badge');
      const text = document.getElementById('best-day-text');
      if(!dates || dates.length===0){ badge.classList.add('hidden'); return; }

      const idx = getBestIndex(okCounts||[]);
      const label = idx>=0 ? humanDate(dates[idx]) : null;

      if(label){
        text.textContent = `${label}ï¼ˆâ—‹ ${okCounts[idx]}äººï¼‰`;
        badge.classList.remove('hidden');
      }else{
        badge.classList.add('hidden');
      }
    }

    function renderSummaryWidgets(dates, participants){
      const summary = computeSummary(dates, participants);
      renderSummaryChart(dates, summary);      // â­•ï¸ã ã‘æç”»
      renderBestBadge(dates, summary['â—‹']);    // ğŸ‘‘
      renderRanking(dates, summary['â—‹'], summary['â–³']); // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆåŒç‡ã¯â–³å¤šã„æ–¹ã‚’ä¸Šï¼‰
    }
    // ============================================

    // ======== ç´™å¹é›ªãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ========
    function confettiBurst(options={}){
      const { mini=false } = options;
      const count = mini ? 80 : 180;
      const spread = mini ? 50 : 75;
      const ticks = mini ? 150 : 220;
      const gravity = mini ? 1.0 : 0.9;

      confetti({ particleCount: Math.floor(count*0.6), spread, startVelocity:45, gravity, origin:{x:.5,y:.4}, ticks });
      setTimeout(()=> confetti({ particleCount: Math.floor(count*0.4), spread:spread+10, startVelocity:55, gravity, origin:{x:.5,y:.6}, ticks }),120);
      setTimeout(()=>{
        confetti({ particleCount: Math.floor(count*0.3), angle:60, spread:spread+10, origin:{x:0,y:.5}, ticks });
        confetti({ particleCount: Math.floor(count*0.3), angle:120, spread:spread+10, origin:{x:1,y:.5}, ticks });
      },180);
    }
    // ============================================

    initialize();
  </script>
</body>
</html>
